"""
Streamlit 헬퍼 함수: 지표 설명 및 UI 컴포넌트
"""

# ==========================================
# 지표 설명 딕셔너리
# ==========================================

METRIC_EXPLANATIONS = {
    "CAGR": {
        "이름": "복합 연간 성장률",
        "영문": "Compound Annual Growth Rate",
        "간단": "연평균으로 얼마나 성장했는가",
        "상세": "투자 기간 전체에 걸친 평균 연율 수익률. 예: 20%는 연간 평균 20% 성장을 의미합니다.",
        "계산": "NAV 종가 / NAV 시작가 ^ (1/연수) - 1",
        "해석": "높을수록 좋음",
    },
    "변동성": {
        "이름": "연율화 변동성",
        "영문": "Annualized Volatility / Standard Deviation",
        "간단": "수익률의 불안정성(변동의 크기)",
        "상세": "매일의 수익률 표준편차를 연율화. 값이 클수록 등락이 심합니다.",
        "계산": "일일 수익률 표준편차 × √252",
        "해석": "낮을수록 안정적(다만 저수익 가능성)",
    },
    "샤프": {
        "이름": "샤프 지수",
        "영문": "Sharpe Ratio",
        "간단": "위험당 수익률 효율성",
        "상세": "같은 위험 수준에서 더 많은 수익을 얻고 있는지 측정. 1.0 이상이 목표.",
        "계산": "(CAGR - 무위험률) / 변동성",
        "해석": "높을수록 효율적(1.0 이상 양호, 2.0 이상 우수)",
    },
    "최대낙폭": {
        "이름": "최대 낙폭",
        "영문": "Maximum Drawdown",
        "간단": "피크에서 바닥까지의 최악 낙폭",
        "상세": "과거의 최대 손실 시나리오. 예: -30%는 최악일 때 30% 하락을 의미합니다.",
        "계산": "최솟값 = min(NAV_t / max(NAV)_과거) - 1",
        "해석": "0에 가까울수록 좋음(손실 적음, 음수값)",
    },
    "위험기여도": {
        "이름": "위험 기여도",
        "영문": "Risk Contribution",
        "간단": "포트폴리오 전체 위험 중 이 자산이 차지하는 비율",
        "상세": "가중 평균 변동성 분해. 각 자산이 전체 위험에 얼마나 기여하는지.",
        "계산": "(가중치 × 한계 위험 기여도) / 포트폴리오 분산",
        "해석": "등가중 배분에서는 모든 자산이 균등. 현재 배분에서 과도한 기여가 없는지 확인.",
    },
    "수익기여도": {
        "이름": "수익 기여도",
        "영문": "Return Contribution",
        "간단": "포트폴리오 전체 수익 중 이 자산이 차지하는 비율",
        "상세": "각 자산의 CAGR과 배분비의 곱. 전체 수익을 어느 자산이 이끌고 있는지.",
        "계산": "CAGR × 배분비",
        "해석": "위험과 수익의 균형을 확인. 고위험 고수익인가, 저위험 저수익인가.",
    },
    "가중치": {
        "이름": "포트폴리오 가중치",
        "영문": "Weight / Allocation",
        "간단": "이 자산에 투자한 금액의 비율",
        "상세": "전체 포트폴리오에 차지하는 투자 금액의 비율. 합계 100%.",
        "계산": "이 자산 투자액 / 전체 투자액",
        "해석": "높을수록 집중도 높음. 분산을 고려하여 설정.",
    },
    "베타": {
        "이름": "베타",
        "영문": "Beta",
        "간단": "벤치마크 대비 자산의 변동성 (체계적 위험)",
        "상세": "베타 = 1이면 벤치마크와 같은 변동성, <1이면 변동성 낮음, >1이면 변동성 높음.",
        "계산": "자산과 벤치마크의 공분산 / 벤치마크의 분산",
        "해석": "1에 가까울수록 벤치마크 추종. 높을수록 벤치마크 상승 시 더 올라감 (양날의 검).",
    },
    "알파": {
        "이름": "알파",
        "영문": "Alpha",
        "간단": "벤치마크를 초과한 수익률 (초과 성과)",
        "상세": "Alpha = 자산수익 - (무위험률 + Beta × 벤치마크초과수익). 양수이면 벤치마크 대비 우수.",
        "계산": "CAGR - (RF + Beta × (BenchCAGR - RF))",
        "해석": "양수이고 높을수록 좋음 (벤치마크 초과 성과 창출). 음수면 벤치마크 미달.",
    },
    "IR": {
        "이름": "정보 비율",
        "영문": "Information Ratio",
        "간단": "벤치마크 대비 초과수익을 추적오차로 조정한 효율성",
        "상세": "자산이 벤치마크를 얼마나 효율적으로 이길 수 있는지 측정. 높을수록 벤치마크 대비 성과가 안정적으로 우수함.",
        "계산": "(자산 CAGR - 벤치마크 CAGR) / 추적오차",
        "해석": "양수이고 높을수록 좋음 (1.0 이상 우수). NaN은 벤치마크 미설정을 의미.",
    },
    "E": {
        "이름": "효율 점수",
        "영문": "Efficiency Score",
        "간단": "샤프와 IR을 통합한 종합 효율성 지표",
        "상세": "E = 0.6·Sharpe_norm + 0.4·IR_norm (z-score→CDF 정규화). 위험 조정 수익률을 종합적으로 평가.",
        "계산": "Sharpe와 IR을 독립적으로 정규화 후 가중결합",
        "해석": "[0,1] 범위; 0.5 이상이면 효율 높음, 1.0에 가까울수록 최상.",
    },
    "RC_Over": {
        "이름": "위험 기여도 초과",
        "영문": "Risk Contribution Over-Budget",
        "간단": "목표 위험 기여도 대비 현재 위험 기여도의 초과분",
        "상세": "RC_Over = max(0, RC - RC_Target). 포트폴리오의 위험 예산을 얼마나 초과했는지 측정.",
        "계산": "위험기여도 - RC_Target (음수는 0으로 처리)",
        "해석": "0에 가까울수록 좋음 (목표 달성). 높을수록 과노출 상태.",
    },
}

QUADRANT_DEFINITIONS = {
    "Q1 핵심": {
        "설명": "**추천**: 저위험 ✓ 고효율 ✓",
        "상세": "RC_Over ≤ 0 & E ≥ 0.5. 탄탄하고 효율적. 포트폴리오의 기초로서 안심.",
        "행동": "유지 또는 소폭 증가",
    },
    "Q2 성장": {
        "설명": "**주시**: 고위험 ⚠ 고효율 ✓",
        "상세": "RC_Over > 0 & E ≥ 0.5. 성장성은 높지만 위험 예산 초과. 위험 허용도에 따라 감량.",
        "행동": "일부 감량하여 목표 도달 후 유지",
    },
    "Q3 개선": {
        "설명": "**검토**: 저위험 ✓ 저효율 ⚠",
        "상세": "RC_Over ≤ 0 & E < 0.5. 위험은 낮지만 효율이 떨어짐. 현금 보유나 다른 자산으로 교체 검토.",
        "행동": "필요에 따라 다른 자산으로 교체",
    },
    "Q4 위험관리": {
        "설명": "**축소 🛑**: 고위험 ⚠ 저효율 ⚠",
        "상세": "RC_Over > 0 & E < 0.5. 위험도 높은데 효율이 낮음. 위험 예산 확보 및 효율성 개선을 위해 축소 후보 1순위.",
        "행동": "단계적으로 축소·청산 검토",
    },
}


def show_metric_info(metric_key: str) -> None:
    """
    지정된 지표의 설명 정보 박스를 표시합니다.

    Args:
        metric_key: METRIC_EXPLANATIONS의 키
    """
    import streamlit as st

    if metric_key not in METRIC_EXPLANATIONS:
        return

    m = METRIC_EXPLANATIONS[metric_key]
    info_text = f"**{m['이름']}** ({m['영문']})\n\n{m['간단']}"
    st.info(info_text)


def show_metric_help_expander() -> None:
    """
    모든 지표 설명을 전개 가능한 섹션으로 표시합니다.
    """
    import streamlit as st

    with st.expander("ℹ️ 지표 설명 (클릭하여 전개)", expanded=False):
        for key, meta in METRIC_EXPLANATIONS.items():
            with st.expander(f"{meta['이름']} ({meta['영문']})", expanded=False):
                st.markdown(f"**간단 설명**: {meta['간단']}")
                st.markdown(f"**상세 설명**: {meta['상세']}")
                st.markdown(f"**계산식**: `{meta['계산']}`")
                st.markdown(f"**해석**: {meta['해석']}")


def show_quadrant_explanations() -> None:
    """
    사분면 분류의 정의와 추천 행동을 표시합니다.
    """
    import streamlit as st

    cols = st.columns(2)
    with cols[0]:
        st.markdown("#### Q1 & Q2: 효율적인 자산")
        for q in ["Q1 핵심", "Q2 성장"]:
            d = QUADRANT_DEFINITIONS[q]
            st.markdown(f"**{q}**: {d['설명']}\n\n{d['상세']}")

    with cols[1]:
        st.markdown("#### Q3 & Q4: 효율이 낮은 자산")
        for q in ["Q3 개선", "Q4 위험관리"]:
            d = QUADRANT_DEFINITIONS[q]
            st.markdown(f"**{q}**: {d['설명']}\n\n{d['상세']}")
