{% if proposal_df is defined and proposal_df is not none %}
<div class="space-y-6">
    <!-- Quadrant Chart -->
    <div>
        <h3 class="text-lg font-semibold mb-4">ì‚¬ë¶„ë©´ ë¶„ë¥˜ (<span class="tooltip-trigger" data-tooltip="ìœ„í—˜ê¸°ì—¬ë„ ì´ˆê³¼ë¶„ (RC_Over). ìœ„í—˜ê¸°ì—¬ë„ê°€ ëª©í‘œì¹˜ë¥¼ ì´ˆê³¼í•œ ì •ë„ì…ë‹ˆë‹¤. ê³µì‹: RC_Over = RC - RC_Target. ì–‘ìˆ˜ë©´ ìœ„í—˜ê¸°ì—¬ë„ê°€ ëª©í‘œì¹˜ë³´ë‹¤ ë†’ê³ , ìŒìˆ˜ë©´ ë‚®ìŠµë‹ˆë‹¤.">RC_Over</span> vs <span class="tooltip-trigger" data-tooltip="íš¨ìœ¨ ì ìˆ˜ (Efficiency Score). Sharpeì™€ IRì„ z-scoreâ†’CDFë¡œ ì •ê·œí™”í•˜ì—¬ ê²°í•©í•œ ê°’ì…ë‹ˆë‹¤. ê³µì‹: E = 0.6Ã—Sharpe_norm + 0.4Ã—IR_norm (0~1 ë²”ìœ„).">íš¨ìœ¨E</span>)</h3>
        <div class="w-full" style="position: relative; height: 500px;">
            <canvas id="quadrant_chart"></canvas>
        </div>
    </div>

    <!-- Action Plan -->
    <div>
        <h3 class="text-lg font-semibold mb-4">ğŸ“Œ ì‹¤í–‰ ê³„íš (ìë™ ìƒì„±)</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <!-- Sell List -->
            <div>
                <h4 class="font-medium mb-2">(1) ì¶•ì†Œ / ì²­ì‚° â€” ìœ„í—˜ê´€ë¦¬ (Q4)</h4>
                {% if sell_list is defined and sell_list|length > 0 %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left">í‹°ì»¤</th>
                        <th class="px-4 py-2 text-left"><span class="tooltip-trigger" data-tooltip="í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ì—ì„œì˜ ìì‚° ë¹„ì¤‘ì…ë‹ˆë‹¤.">í˜„ì¬%</span></th>
                        <th class="px-4 py-2 text-left"><span class="tooltip-trigger" data-tooltip="ëª©í‘œ ë¹„ì¤‘ê³¼ í˜„ì¬ ë¹„ì¤‘ì˜ ì°¨ì´ì…ë‹ˆë‹¤. ì–‘ìˆ˜ë©´ ì¦ê°€ í•„ìš”, ìŒìˆ˜ë©´ ê°ì†Œ í•„ìš”ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.">ê°­%</span></th>
                    </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for row in sell_list %}
                            <tr>
                                <td class="px-4 py-2">{{ row.ticker }}</td>
                                <td class="px-4 py-2">{{ "%.2f"|format(row['í˜„ì¬%']) }}</td>
                                <td class="px-4 py-2">{{ "%.2f"|format(row['ê°­%']) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-gray-500 text-sm">ì¶•ì†Œ ëŒ€ìƒ ì—†ìŒ</p>
                {% endif %}
            </div>

            <!-- Buy List -->
            <div>
                <h4 class="font-medium mb-2">(2) ì¦ê°€ â€” ì–‘ìˆ˜ ê°­ (í˜„ê¸ˆì¤‘ë¦½ ìŠ¤ì¼€ì¼ë§)</h4>
                {% if buy_list is defined and buy_list|length > 0 %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left">í‹°ì»¤</th>
                        <th class="px-4 py-2 text-left"><span class="tooltip-trigger" data-tooltip="í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ì—ì„œì˜ ìì‚° ë¹„ì¤‘ì…ë‹ˆë‹¤.">í˜„ì¬%</span></th>
                        <th class="px-4 py-2 text-left"><span class="tooltip-trigger" data-tooltip="ëª©í‘œ ë¹„ì¤‘ê³¼ í˜„ì¬ ë¹„ì¤‘ì˜ ì°¨ì´ì…ë‹ˆë‹¤. ì–‘ìˆ˜ë©´ ì¦ê°€ í•„ìš”, ìŒìˆ˜ë©´ ê°ì†Œ í•„ìš”ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.">ê°­%</span></th>
                    </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for row in buy_list %}
                            <tr>
                                <td class="px-4 py-2">{{ row.ticker }}</td>
                                <td class="px-4 py-2">{{ "%.2f"|format(row['í˜„ì¬%']) }}</td>
                                <td class="px-4 py-2">{{ "%.2f"|format(row['ê°­%']) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-gray-500 text-sm">ì¦ê°€ ëŒ€ìƒ ì—†ìŒ</p>
                {% endif %}
            </div>
        </div>

        <!-- Fine Tune List -->
        <div>
            <h4 class="font-medium mb-2">(3) ì„¸ë¶€ ì¡°ì • â€” Q1/Q2 ì‘ì€ ì¡°ì • (|ê°­| â‰¤ 1%)</h4>
            {% if fine_tune_list is defined and fine_tune_list|length > 0 %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left">í‹°ì»¤</th>
                        <th class="px-4 py-2 text-left"><span class="tooltip-trigger" data-tooltip="í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ì—ì„œì˜ ìì‚° ë¹„ì¤‘ì…ë‹ˆë‹¤.">í˜„ì¬%</span></th>
                        <th class="px-4 py-2 text-left"><span class="tooltip-trigger" data-tooltip="ëª©í‘œ ë¹„ì¤‘ê³¼ í˜„ì¬ ë¹„ì¤‘ì˜ ì°¨ì´ì…ë‹ˆë‹¤. ì–‘ìˆ˜ë©´ ì¦ê°€ í•„ìš”, ìŒìˆ˜ë©´ ê°ì†Œ í•„ìš”ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.">ê°­%</span></th>
                    </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for row in fine_tune_list %}
                        <tr>
                            <td class="px-4 py-2">{{ row.ticker }}</td>
                            <td class="px-4 py-2">{{ "%.2f"|format(row['í˜„ì¬%']) }}</td>
                            <td class="px-4 py-2">{{ "%.2f"|format(row['ê°­%']) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-500 text-sm">ë¯¸ì„¸ ì¡°ì • ëŒ€ìƒ ì—†ìŒ</p>
            {% endif %}
        </div>
    </div>

    <!-- RC Violations -->
    {% if rc_violations is defined and rc_violations|length > 0 %}
    <div>
        <h3 class="text-lg font-semibold mb-4">âš ï¸ RC ìƒí•œì„  ì²´í¬</h3>
        <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded">
            <p class="text-sm font-medium">âš ï¸ {{ rc_violations|length }}ê°œ ìì‚°ì˜ RCê°€ ìƒí•œì„ ì´ˆê³¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
        <div class="overflow-x-auto mt-2">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left">í‹°ì»¤</th>
                        <th class="px-4 py-2 text-left"><span class="tooltip-trigger" data-tooltip="í˜„ì¬ ìœ„í—˜ê¸°ì—¬ë„ (Risk Contribution). í¬íŠ¸í´ë¦¬ì˜¤ ì „ì²´ ìœ„í—˜ì— ëŒ€í•œ ê° ìì‚°ì˜ í˜„ì¬ ê¸°ì—¬ ë¹„ìœ¨ì…ë‹ˆë‹¤.">í˜„ì¬RC%</span></th>
                        <th class="px-4 py-2 text-left"><span class="tooltip-trigger" data-tooltip="ìœ„í—˜ê¸°ì—¬ë„ ìƒí•œì„ . ê° ìì‚°ì˜ ìœ„í—˜ê¸°ì—¬ë„ê°€ ì´ˆê³¼í•˜ë©´ ì•ˆ ë˜ëŠ” ìµœëŒ€ê°’ì…ë‹ˆë‹¤.">RCìƒí•œ%</span></th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for row in rc_violations %}
                    <tr>
                        <td class="px-4 py-2">{{ row.ticker }}</td>
                        <td class="px-4 py-2">{{ "%.2f"|format(row['í˜„ì¬RC%']) }}</td>
                        <td class="px-4 py-2">{{ "%.2f"|format(row['RCìƒí•œ%']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded">
        <p class="text-sm font-medium">âœ… ëª¨ë“  ìì‚°ì˜ RCê°€ ìƒí•œì„  ë‚´ì— ìˆìŠµë‹ˆë‹¤.</p>
    </div>
    {% endif %}

    <!-- Download Links -->
    <div>
        <h3 class="text-lg font-semibold mb-4">â¬‡ï¸ ì¶œë ¥ ë‹¤ìš´ë¡œë“œ</h3>
        <div class="flex gap-4">
            <a href="/api/evaluation/download-csv?type=metrics" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">ë³´ê°•ëœ ë©”íŠ¸ë¦­ ë‹¤ìš´ë¡œë“œ (CSV)</a>
            <a href="/api/evaluation/download-csv?type=proposal" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">ì‹¤í–‰ ê³„íš ë‹¤ìš´ë¡œë“œ (CSV)</a>
        </div>
    </div>
</div>

<script>
// Render Chart.js scatter chart
// This function will be called after HTMX swaps the content
// Make it globally accessible for HTMX event handlers
window.initQuadrantChart = function() {
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        setTimeout(initQuadrantChart, 100); // Retry after 100ms
        return;
    }
    
    // Check if canvas element exists
    const canvas = document.getElementById('quadrant_chart');
    if (!canvas) {
        console.error('Canvas element not found');
        return;
    }
    
    // Destroy existing chart if it exists
    if (canvas.chart) {
        canvas.chart.destroy();
    }
    
    try {
        // Parse JSON data (it's already a JSON string from backend)
        const chartDataJson = {{ quadrant_chart_json|safe }};
        const chartData = typeof chartDataJson === 'string' ? JSON.parse(chartDataJson) : chartDataJson;
        
        if (!chartData || !chartData.datasets || !chartData.datasets[0]) {
            console.error('Invalid chart data:', chartData);
            return;
        }
        
        const ctx = canvas.getContext('2d');
        
        // Register plugins
        if (typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
        }
        
        // Prepare datasets with ticker labels
        const scatterDataset = chartData.datasets[0];
        const scatterData = scatterDataset.data.map(point => ({
            x: point.x,
            y: point.y,
            ticker: point.ticker
        }));
        
        // Calculate data range for threshold lines
        const xValues = scatterData.map(p => p.x);
        const yValues = scatterData.map(p => p.y);
        const xMin = Math.min(...xValues, 0);
        const xMax = Math.max(...xValues, chartData.thresholds.rc_over * 1.2);
        const yMin = Math.min(...yValues, 0);
        const yMax = Math.max(...yValues, chartData.thresholds.efficiency * 1.2);
        
        // Create scatter chart with threshold lines as additional datasets
        canvas.chart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: scatterDataset.label,
                        data: scatterData,
                        backgroundColor: scatterDataset.backgroundColor,
                        borderColor: scatterDataset.borderColor,
                        pointRadius: scatterDataset.pointRadius,
                        pointHoverRadius: scatterDataset.pointHoverRadius
                    },
                    // Vertical threshold line (RC_Over)
                    {
                        label: 'RC_Over Thresh',
                        data: [
                            {x: chartData.thresholds.rc_over, y: yMin},
                            {x: chartData.thresholds.rc_over, y: yMax}
                        ],
                        borderColor: 'red',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        fill: false,
                        showLine: true,
                        tension: 0
                    },
                    // Horizontal threshold line (Efficiency)
                    {
                        label: 'E Thresh',
                        data: [
                            {x: xMin, y: chartData.thresholds.efficiency},
                            {x: xMax, y: chartData.thresholds.efficiency}
                        ],
                        borderColor: 'red',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        fill: false,
                        showLine: true,
                        tension: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: chartData.labels.title,
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const point = context.raw;
                                if (point.ticker) {
                                    return [
                                        `í‹°ì»¤: ${point.ticker}`,
                                        `RC_Over: ${point.x.toFixed(2)}%`,
                                        `E: ${point.y.toFixed(2)}`
                                    ];
                                }
                                return context.dataset.label + ': ' + 
                                    (context.parsed.x !== undefined ? `X: ${context.parsed.x.toFixed(2)}` : '') +
                                    (context.parsed.y !== undefined ? ` Y: ${context.parsed.y.toFixed(2)}` : '');
                            }
                        }
                    },
                    legend: {
                        display: true,
                        labels: {
                            filter: function(item, chart) {
                                // Hide threshold lines from legend
                                return !item.text.includes('Thresh');
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'top',
                        align: 'top',
                        offset: 5,
                        font: {
                            size: 8
                        },
                        formatter: function(value, context) {
                            // Only show ticker labels for scatter points
                            return context.raw && context.raw.ticker ? context.raw.ticker : '';
                        },
                        display: function(context) {
                            // Only display labels for scatter points (first dataset) that have ticker property
                            return context.datasetIndex === 0 && 
                                   context.raw && 
                                   context.raw.ticker !== undefined;
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: chartData.labels.x
                        },
                        beginAtZero: true
                    },
                    y: {
                        title: {
                            display: true,
                            text: chartData.labels.y
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error rendering chart:', error);
        console.error('Chart data:', {{ quadrant_chart_json|safe }});
    }
};

// Initialize chart immediately (for direct page load)
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initQuadrantChart);
} else {
    initQuadrantChart();
}

// Also initialize when HTMX swaps content
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'evaluation_results') {
        setTimeout(initQuadrantChart, 50); // Small delay to ensure DOM is ready
        // Initialize tooltips after evaluation results are displayed
        if (typeof initTooltips === 'function') {
            setTimeout(initTooltips, 100);
        }
    }
});
</script>
{% else %}
<p class="text-gray-500 text-sm">í‰ê°€ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}
